
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>荷物スキャン & リスト化（対応策A：マルチCDN）</title>
  <meta name="theme-color" content="#111111" />
  <style>
    :root{
      --bg:#f5f5f7; --fg:#111; --muted:#666; --card:#fff; --primary:#0a7; --danger:#c33; --dark:#333;
      --chip:#eee; --chip-on:#111; --chip-on-fg:#fff;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:12px;display:grid;gap:12px}
    h1{font-size:18px;margin:4px 0 0;font-weight:800}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
    .row{display:grid;gap:6px;margin-bottom:8px}
    .label{font-weight:700;font-size:13px}
    .input, select{border:1px solid #ccc;border-radius:8px;padding:10px;background:#fff;font-size:16px}
    .btn{border:none;border-radius:10px;padding:12px 14px;font-weight:700;font-size:15px;color:#fff;background:var(--primary);cursor:pointer}
    .btn.dark{background:var(--dark)}
    .btn.danger{background:var(--danger)}
    .btn.ghost{background:#e5e5e5;color:#111}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:var(--chip);cursor:pointer;border:1px solid #ccc}
    .chip.on{background:var(--chip-on);color:var(--chip-on-fg);border-color:var(--chip-on)}
    .group{background:#fafafa;border-radius:12px;padding:10px;margin-bottom:10px}
    .group h3{margin:0 0 8px;font-size:15px}
    .rowItem{display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px solid #eee}
    .muted{color:var(--muted);font-size:12px}
    video{width:100%;border-radius:12px;background:#000}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .note{font-size:12px;color:#555}
    .warn{background:#fff4d6;border:1px solid #ffd36b;color:#7a5b00;padding:8px;border-radius:8px}
  </style>

  <!-- ▼ ZXingローダー：unpkg → jsDelivr → ローカル の順で自動トライ -->
  <script>
  (function injectZXing() {
    const candidates = [
      "https://unpkg.com/@zxing/browser@0.1.5/umd/index.min.js",
      "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js",
      "./zxing-browser.min.js" // 後で置けば自動で使う
    ];
    let idx = 0;
    function tryNext() {
      if (idx >= candidates.length) {
        console.warn("ZXing のロード候補が全て失敗しました。");
        return;
      }
      const src = candidates[idx++];
      const s = document.createElement("script");
      s.src = src + "?v=" + Date.now(); // キャッシュ回避
      s.async = true;
      s.onload = () => console.log("ZXing loaded:", src);
      s.onerror = () => { console.warn("ZXing load failed:", src); tryNext(); };
      document.head.appendChild(s);
    }
    tryNext();
  })();
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>荷物スキャン & リスト化（インストール不要・iOS/Android対応・ZXing互換）</h1>
      <div class="warn" id="httpsWarn" style="display:none">
        カメラ利用には <b>https / localhost</b> が必要です。GitHub Pages の https URL から開いてください。
      </div>
      <div class="note">
        ・店名は扱いません。<b>コード・都道府県・運送会社・サイズ・サービス・個口</b>のみ。<br/>
        ・任意：<b>マスタCSV（code,prefecture,carrier）</b>を読み込むと補完されます。
      </div>
    </div>

    <!-- スキャン & 入力 -->
    <div class="card">
      <div class="toolbar">
        <button class="btn dark" id="startScanBtn">スキャン開始</button>
        <button class="btn ghost" id="stopScanBtn">停止</button>
        <input type="file" accept="text/csv" id="masterFile" style="display:none" />
        <button class="btn ghost" id="loadMasterBtn">マスタCSV読込</button>
        <button class="btn ghost" id="exportMasterBtn" title="現在のマスタをCSVとして書き出し">マスタCSV書出</button>
        <button class="btn ghost" onclick="alert(window.ZXingBrowser||window.ZXing?'OK: ZXing loaded':'NG: ZXing not loaded')">ZXing読込確認</button>
      </div>
      <video id="preview" playsinline muted></video>
      <div id="scanError" class="warn" style="display:none;margin-top:8px"></div>
      <div class="note">※ BarcodeDetector 非対応端末は ZXing 互換モードに自動切替。</div>

      <div class="row">
        <div class="label">コード（スキャン or 手入力）</div>
        <input class="input" id="code" placeholder="スキャンすると自動で入ります">
      </div>

      <div class="row">
        <div class="label">サイズ</div>
        <div class="chips" id="sizeChips"></div>
      </div>

      <div class="row">
        <div class="label">サービス</div>
        <div class="chips" id="serviceChips"></div>
      </div>

      <div class="row">
        <div class="label">都道府県</div>
        <select id="prefSel" class="input"></select>
      </div>

      <div class="row">
        <div class="label">個口数</div>
        <input class="input" id="qty" type="number" min="1" value="1" style="max-width:140px">
      </div>

      <div class="row">
        <div class="label">運送会社</div>
        <div class="chips" id="carrierChips"></div>
      </div>

      <div class="toolbar">
        <button class="btn" id="addBtn">追加</button>
        <button class="btn danger" id="clearAllBtn">全削除</button>
      </div>
    </div>

    <!-- リスト表示 -->
    <div class="card">
      <div class="toolbar">
        <button class="btn" id="exportCsvBtn">CSVエクスポート</button>
        <label class="flex" style="gap:6px">
          <input type="checkbox" id="splitByCarrier"> キャリア別に分割出力
        </label>
      </div>
      <div id="listContainer"></div>
    </div>

    <div class="card">
      <div class="note">
        保存先：この端末のブラウザ内（localStorage）。<br/>
        ルール：<b>マスタ未設定時</b>は簡易推奨（関東=ヤマト、関西=佐川、他=日本郵便／クール=ヤマト）。<br/>
        互換性：BarcodeDetector 非対応端末は ZXing 互換モードで読み取り。
      </div>
    </div>
  </div>

  <script>
  // ======== 定義 ========
  const SIZES = ["60","80","100","120","140","160","180","200"];
  const SERVICES = ["常温","クール"];
  const CARRIERS = ["ヤマト運輸","佐川急便","日本郵便"];
  const PREFS = ["北海道","青森県","岩手県","宮城県","秋田県","山形県","福島県","茨城県","栃木県","群馬県","埼玉県","千葉県","東京都","神奈川県","新潟県","富山県","石川県","福井県","山梨県","長野県","岐阜県","静岡県","愛知県","三重県","滋賀県","京都府","大阪府","兵庫県","奈良県","和歌山県","鳥取県","島根県","岡山県","広島県","山口県","徳島県","香川県","愛媛県","高知県","福岡県","佐賀県","長崎県","熊本県","大分県","宮崎県","鹿児島県","沖縄県"];

  // ======== 状態 ========
  const state = {
    size: "80",
    service: "常温",
    carrier: "ヤマト運輸",
    pref: "愛知県",
    list: [],           // 1レコード=1個口
    master: {},         // code -> { prefecture, carrier }
  };

  // ======== 要素 ========
  const el = {
    httpsWarn: document.getElementById("httpsWarn"),
    preview: document.getElementById("preview"),
    startScanBtn: document.getElementById("startScanBtn"),
    stopScanBtn: document.getElementById("stopScanBtn"),
    code: document.getElementById("code"),
    sizeChips: document.getElementById("sizeChips"),
    serviceChips: document.getElementById("serviceChips"),
    carrierChips: document.getElementById("carrierChips"),
    prefSel: document.getElementById("prefSel"),
    qty: document.getElementById("qty"),
    addBtn: document.getElementById("addBtn"),
    clearAllBtn: document.getElementById("clearAllBtn"),
    listContainer: document.getElementById("listContainer"),
    exportCsvBtn: document.getElementById("exportCsvBtn"),
    splitByCarrier: document.getElementById("splitByCarrier"),
    masterFile: document.getElementById("masterFile"),
    loadMasterBtn: document.getElementById("loadMasterBtn"),
    exportMasterBtn: document.getElementById("exportMasterBtn"),
    scanError: document.getElementById("scanError"),
  };

  // ======== 初期UI構築 ========
  function initChips(container, items, currentGetter, onSelect) {
    container.innerHTML = "";
    items.forEach(v => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "chip" + (currentGetter()===v?" on":"");
      b.textContent = v;
      b.onclick = () => {
        onSelect(v);
        initChips(container, items, currentGetter, onSelect);
        refreshCarrierAuto();
      };
      container.appendChild(b);
    });
  }

  function buildPrefSelect() {
    el.prefSel.innerHTML = PREFS.map(p => `<option value="${p}">${p}</option>`).join("");
    el.prefSel.value = state.pref;
    el.prefSel.onchange = () => { state.pref = el.prefSel.value; refreshCarrierAuto(); persist(); };
  }

  function renderGroups() {
    const groups = CARRIERS.map(c => ({carrier:c, items: state.list.filter(x => x.carrier === c)}));
    el.listContainer.innerHTML = groups.map(g => {
      const rows = g.items.map(x => `
        <div class="rowItem">
          <div>
            <div><b>${escapeHtml(x.code)}</b> <span class="muted">(${x.size}/${x.service}/${x.prefecture})</span></div>
          </div>
          <div class="muted">${new Date(x.createdAt).toLocaleString()}</div>
        </div>
      `).join("");
      return `
        <div class="group">
          <h3>${g.carrier}（${g.items.length}件）</h3>
          ${rows || '<div class="muted">なし</div>'}
        </div>
      `;
    }).join("");
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ======== 推奨キャリア（簡易） ========
  function recommendCarrier(size, pref, service){
    if (service === "クール") return "ヤマト運輸";
    const KANTO = ["東京都","神奈川県","千葉県","埼玉県","茨城県","栃木県","群馬県"];
    const KANSAI = ["大阪府","京都府","兵庫県","滋賀県","奈良県","和歌山県"];
    if (KANTO.includes(pref)) return "ヤマト運輸";
    if (KANSAI.includes(pref)) return "佐川急便";
    return "日本郵便";
  }

  function refreshCarrierAuto(){
    const code = el.code.value.trim();
    if (code && state.master[code]?.carrier) {
      state.carrier = state.master[code].carrier;
    } else {
      state.carrier = recommendCarrier(state.size, state.pref, state.service);
    }
    initChips(el.carrierChips, CARRIERS, () => state.carrier, v => { state.carrier=v; persist(); });
  }

  // ======== スキャン（BarcodeDetector -> ZXing フォールバック） ========
  let mediaStream = null;       // 自前 getUserMedia（BD時のみ）
  let scanning = false;
  let detector = null;          // BarcodeDetector
  let zxingReader = null;       // ZXing Reader
  let zxingControls = null;     // ZXing 停止ハンドル

  function showScanError(msg) {
    el.scanError.style.display = "block";
    el.scanError.textContent = "カメラ初期化エラー: " + msg;
  }
  function clearScanError() {
    el.scanError.style.display = "none";
    el.scanError.textContent = "";
  }

  async function startScan(){
    clearScanError();
    if ('BarcodeDetector' in window) {
      // BarcodeDetector あり → 自前で getUserMedia
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } }, audio: false });
        el.preview.srcObject = mediaStream;
        await el.preview.play();
        scanning = true;
        const formats = ['qr_code','code_128','ean_13','upc_a','itf'];
        detector = new window.BarcodeDetector({ formats });
        scanLoop();
      } catch (e) {
        handleGumError(e);
      }
    } else {
      // ZXing に全任せ（こちらは getUserMedia しない）
      await startZxingFallback();
    }
  }

  function handleGumError(e){
    console.error(e);
    if (e.name === "NotAllowedError") {
      showScanError("カメラの権限が許可されていません。ブラウザの権限設定で『カメラを許可』してください。");
    } else if (e.name === "NotFoundError" || e.message?.includes("device not found")) {
      showScanError("カメラデバイスが見つかりません。別の端末やブラウザでお試しください。");
    } else if (location.protocol !== "https:" && location.hostname !== "localhost")) {
      showScanError("https で開かれていません。GitHub Pages の https URL で開いてください。");
    } else {
      showScanError(e.message || String(e));
    }
    alert("カメラを開始できませんでした。上の注意を確認してください。");
  }

  async function scanLoop(){
    if (!scanning || !detector) return;
    try {
      const codes = await detector.detect(el.preview);
      if (codes && codes.length > 0) {
        const v = (codes[0].rawValue || "").trim();
        if (v) {
          scanning = false;
          stopScan(false);
          onCodeDetected(v);
          return;
        }
      }
    } catch(e) { /* noop */ }
    requestAnimationFrame(scanLoop);
  }

  async function startZxingFallback(){
    try {
      const ZX = window.ZXingBrowser || window.ZXing;
      if (!ZX) {
        showScanError("ZXing ライブラリが読み込めていません（CDN/ネットワークでブロック）");
        return;
      }
      zxingReader = new ZX.BrowserMultiFormatReader(undefined, 350);
      scanning = true;
      const controls = await zxingReader.decodeFromConstraints(
        { video: { facingMode: { ideal: 'environment' } }, audio: false },
        el.preview,
        (result, err, ctl) => {
          if (result) {
            scanning = false;
            zxingControls = ctl;
            stopScan(false);
            onCodeDetected(result.getText());
          }
        }
      );
      zxingControls = controls;
    } catch (e) {
      console.error(e);
      showScanError("ZXing 互換モードの起動に失敗: " + (e.message || e));
    }
  }

  function stopScan(stopVideo = true){
    scanning = false;
    if (zxingControls) { try { zxingControls.stop(); } catch(_){} zxingControls = null; }
    if (zxingReader)    { try { zxingReader.reset(); } catch(_){} zxingReader = null; }
    if (stopVideo && mediaStream) { try { mediaStream.getTracks().forEach(t => t.stop()); } catch(_){} mediaStream = null; }
    detector = null;
    el.preview.srcObject = null;
  }

  function onCodeDetected(value){
    el.code.value = value;
    if (state.master[value]) {
      const m = state.master[value];
      if (m.prefecture) { state.pref = m.prefecture; el.prefSel.value = m.prefecture; }
      if (m.carrier) { state.carrier = m.carrier; }
    }
    refreshCarrierAuto();
    if (navigator.vibrate) navigator.vibrate(50);
  }

  // ======== マスタCSV ========
  function parseCsv(text){
    const lines = text.replace(/\r/g,"").split("\n").filter(l => l.trim());
    if (lines.length === 0) return {};
    let start = 0;
    const first = lines[0].toLowerCase();
    if (first.includes("code") && first.includes("prefecture")) { start = 1; }
    const m = {};
    for (let i=start;i<lines.length;i++){
      const cols = splitCsvLine(lines[i]);
      const code = (cols[0]||"").trim();
      const pref = (cols[1]||"").trim();
      const car  = (cols[2]||"").trim();
      if (!code) continue;
      m[code] = { prefecture: pref || undefined, carrier: car || undefined };
    }
    return m;
  }
  function splitCsvLine(line){
    const out = [];
    let cur = "", inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (inQ){
        if (ch === '"'){
          if (line[i+1] === '"'){ cur+='"'; i++; } else { inQ=false; }
        } else { cur += ch; }
      } else {
        if (ch === ','){ out.push(cur); cur=""; }
        else if (ch === '"'){ inQ = true; }
        else { cur += ch; }
      }
    }
    out.push(cur);
    return out;
  }

  function exportMasterCsv(){
    const rows = [["code","prefecture","carrier"]];
    for (const [code, obj] of Object.entries(state.master)){
      rows.push([code, obj.prefecture||"", obj.carrier||""]);
    }
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    downloadBlob(csv, `master_${Date.now()}.csv`, "text/csv");
  }

  // ======== 追加/削除/保存 ========
  function addItems(){
    const code = el.code.value.trim();
    const qty = Math.max(1, Number(el.qty.value || 1));
    if (!code){ alert("コードが未入力です。スキャンするか手入力してください。"); return; }
    const now = Date.now();
    const newItems = Array.from({length:qty}).map((_,i)=>({
      id: `${now}-${i}`,
      code,
      size: state.size,
      service: state.service,
      prefecture: state.pref,
      carrier: state.carrier,
      createdAt: now + i
    }));
    state.list.unshift(...newItems);
    el.code.value = "";
    el.qty.value = "1";
    persist();
    renderGroups();
  }

  function clearAll(){
    if (!confirm("すべてのリストを削除しますか？")) return;
    state.list = [];
    persist();
    renderGroups();
  }

  function persist(){
    localStorage.setItem("scanner_state_v1", JSON.stringify({
      size: state.size, service: state.service, carrier: state.carrier, pref: state.pref,
      list: state.list, master: state.master
    }));
  }

  function restore(){
    try{
      const raw = localStorage.getItem("scanner_state_v1");
      if (raw){
        const s = JSON.parse(raw);
        state.size = s.size || state.size;
        state.service = s.service || state.service;
        state.carrier = s.carrier || state.carrier;
        state.pref = s.pref || state.pref;
        state.list = Array.isArray(s.list)? s.list : [];
        state.master = s.master || {};
      }
    }catch(e){}
  }

  // ======== CSV出力 ========
  function toCsvRows(items){
    const header = ["code","size","service","carrier","prefecture","kokusu","created_at"];
    const body = items.map(x => [x.code,x.size,x.service,x.carrier,x.prefecture,1,new Date(x.createdAt).toISOString()]);
    return [header, ...body];
  }
  function rowsToCsv(rows){
    return rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  }

  async function exportCsv(){
    if (state.list.length === 0){ alert("リストが空です"); return; }
    const split = el.splitByCarrier.checked;
    if (!split){
      const csv = rowsToCsv(toCsvRows(state.list));
      await shareOrDownload(csv, `shipments_${Date.now()}.csv`);
    } else {
      for (const c of CARRIERS){
        const items = state.list.filter(x => x.carrier===c);
        if (items.length === 0) continue;
        const csv = rowsToCsv(toCsvRows(items));
        await shareOrDownload(csv, `${carrierFileName(c)}_${Date.now()}.csv`);
      }
    }
  }

  function carrierFileName(name){
    if (name.includes("ヤマト")) return "yamato";
    if (name.includes("佐川")) return "sagawa";
    if (name.includes("日本郵便")) return "japanpost";
    return "carrier";
  }

  async function shareOrDownload(csv, filename){
    const blob = new Blob([csv], {type:"text/csv"});
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename, {type:"text/csv"})] })){
      await navigator.share({ files: [new File([blob], filename, {type:"text/csv"})], title: "出力CSV" }).catch(()=>{});
    } else if (navigator.share){
      await navigator.share({ text: csv, title: filename }).catch(()=>{});
    } else {
      downloadBlob(csv, filename, "text/csv");
    }
  }

  function downloadBlob(text, filename, mime){
    const url = URL.createObjectURL(new Blob([text], {type:mime||"text/plain"}));
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  // ======== 起動処理 ========
  (function boot(){
    if (!(location.protocol === "https:" || location.hostname === "localhost")) {
      el.httpsWarn.style.display = "block";
    }

    restore();

    initChips(el.sizeChips, SIZES, () => state.size, v => { state.size=v; persist(); });
    initChips(el.serviceChips, SERVICES, () => state.service, v => { state.service=v; persist(); });
    initChips(el.carrierChips, CARRIERS, () => state.carrier, v => { state.carrier=v; persist(); });
    buildPrefSelect();
    renderGroups();

    el.startScanBtn.onclick = startScan;
    el.stopScanBtn.onclick = () => stopScan(true);
    el.addBtn.onclick = addItems;
    el.clearAllBtn.onclick = clearAll;
    el.exportCsvBtn.onclick = exportCsv;

    el.loadMasterBtn.onclick = () => el.masterFile.click();
    el.masterFile.onchange = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const text = await file.text();
      state.master = parseCsv(text);
      persist();
      alert("マスタを読み込みました（" + Object.keys(state.master).length + "件）");
    };
    el.exportMasterBtn.onclick = exportMasterCsv;

    el.code.addEventListener("change", () => {
      const v = el.code.value.trim();
      if (v && state.master[v]){
        const m = state.master[v];
        if (m.prefecture) { state.pref = m.prefecture; el.prefSel.value = m.prefecture; }
        if (m.carrier) { state.carrier = m.carrier; }
      }
      refreshCarrierAuto();
    });
  })();
  </script>
</body>
</html>
